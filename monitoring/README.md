# SmellPin ç›‘æ§ç³»ç»Ÿ

## æ¦‚è¿°

SmellPin ç›‘æ§ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäº Prometheus + Grafana + AlertManager çš„å®Œæ•´ç›‘æ§è§£å†³æ–¹æ¡ˆï¼Œä¸º SmellPin åº”ç”¨æä¾›å…¨æ–¹ä½çš„æ€§èƒ½ç›‘æ§ã€æ—¥å¿—æ”¶é›†å’Œå‘Šè­¦æœºåˆ¶ã€‚

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SmellPin App  â”‚â”€â”€â”€â–¶â”‚   Prometheus    â”‚â”€â”€â”€â–¶â”‚     Grafana     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ - HTTP Metrics  â”‚    â”‚ - æŒ‡æ ‡æ”¶é›†       â”‚    â”‚ - æ•°æ®å¯è§†åŒ–     â”‚
â”‚ - Business Data â”‚    â”‚ - æ•°æ®å­˜å‚¨       â”‚    â”‚ - ä»ªè¡¨æ¿å±•ç¤º     â”‚
â”‚ - System Info   â”‚    â”‚ - å‘Šè­¦è§„åˆ™       â”‚    â”‚ - ç”¨æˆ·ç•Œé¢       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
         â”‚              â”‚  AlertManager   â”‚              â”‚
         â”‚              â”‚                 â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ - å‘Šè­¦ç®¡ç†       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ - é€šçŸ¥å‘é€       â”‚
                        â”‚ - å‘Šè­¦æŠ‘åˆ¶       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” æ€§èƒ½ç›‘æ§
- **HTTP è¯·æ±‚ç›‘æ§**: è¯·æ±‚æ€»æ•°ã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡
- **ç³»ç»Ÿèµ„æºç›‘æ§**: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œä½¿ç”¨ç‡
- **æ•°æ®åº“ç›‘æ§**: è¿æ¥æ•°ã€æŸ¥è¯¢æ€§èƒ½ã€æ…¢æŸ¥è¯¢ç»Ÿè®¡
- **Redis ç›‘æ§**: å†…å­˜ä½¿ç”¨ã€è¿æ¥æ•°ã€å‘½ä»¤æ‰§è¡Œç»Ÿè®¡
- **WebSocket ç›‘æ§**: è¿æ¥æ•°ã€æ¶ˆæ¯ä¼ è¾“ç»Ÿè®¡

### ğŸ“Š ä¸šåŠ¡æŒ‡æ ‡
- **ç”¨æˆ·è¡Œä¸º**: æ³¨å†Œæ•°ã€æ´»è·ƒç”¨æˆ·ã€ç•™å­˜ç‡
- **æ ‡æ³¨æ•°æ®**: åˆ›å»ºæ•°é‡ã€åœ°ç†åˆ†å¸ƒã€çƒ­é—¨åŒºåŸŸ
- **æ”¯ä»˜ç»Ÿè®¡**: æˆåŠŸç‡ã€æ”¶å…¥ç»Ÿè®¡ã€å¼‚å¸¸ç›‘æ§
- **LBS å¥–åŠ±**: å‘æ”¾ç»Ÿè®¡ã€ç”¨æˆ·å‚ä¸åº¦

### ğŸš¨ å‘Šè­¦æœºåˆ¶
- **ç³»ç»Ÿå‘Šè­¦**: æœåŠ¡å®•æœºã€èµ„æºä½¿ç”¨è¿‡é«˜
- **ä¸šåŠ¡å‘Šè­¦**: å…³é”®æŒ‡æ ‡å¼‚å¸¸ã€ç”¨æˆ·è¡Œä¸ºå¼‚å¸¸
- **å®‰å…¨å‘Šè­¦**: å¯ç–‘ç™»å½•ã€æ”»å‡»æ£€æµ‹
- **å¤šæ¸ é“é€šçŸ¥**: é‚®ä»¶ã€Slackã€çŸ­ä¿¡ã€é’‰é’‰

### ğŸ“ˆ æ•°æ®å¯è§†åŒ–
- **ç³»ç»Ÿæ¦‚è§ˆä»ªè¡¨æ¿**: æ•´ä½“å¥åº·çŠ¶æ€å’Œå…³é”®æŒ‡æ ‡
- **ä¸šåŠ¡ç›‘æ§ä»ªè¡¨æ¿**: ä¸šåŠ¡æ•°æ®å’Œç”¨æˆ·è¡Œä¸ºåˆ†æ
- **æ€§èƒ½åˆ†æä»ªè¡¨æ¿**: è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡å’Œè¶‹åŠ¿
- **å‘Šè­¦ç®¡ç†ç•Œé¢**: å‘Šè­¦å†å²å’ŒçŠ¶æ€ç®¡ç†

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Docker >= 20.10
- Docker Compose >= 2.0
- è‡³å°‘ 4GB å¯ç”¨å†…å­˜
- è‡³å°‘ 10GB å¯ç”¨ç£ç›˜ç©ºé—´

### å®‰è£…éƒ¨ç½²

1. **å…‹éš†é¡¹ç›®å¹¶è¿›å…¥ç›‘æ§ç›®å½•**
   ```bash
   cd /path/to/smellpin/monitoring
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   # ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“è¿æ¥ç­‰ä¿¡æ¯
   cp .env.example .env
   vim .env
   ```

3. **ä¸€é”®éƒ¨ç½²**
   ```bash
   ./deploy.sh deploy
   ```

4. **è®¿é—®æœåŠ¡**
   - Grafana: http://localhost:3001 (admin/admin123)
   - Prometheus: http://localhost:9090
   - AlertManager: http://localhost:9093

### å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
./deploy.sh start

# åœæ­¢æœåŠ¡
./deploy.sh stop

# é‡å¯æœåŠ¡
./deploy.sh restart

# æŸ¥çœ‹çŠ¶æ€
./deploy.sh status

# å¥åº·æ£€æŸ¥
./deploy.sh health

# æŸ¥çœ‹æ—¥å¿—
./deploy.sh logs [service_name]

# æ›´æ–°æœåŠ¡
./deploy.sh update

# æ¸…ç†æ•°æ®
./deploy.sh clean
```

## é…ç½®è¯´æ˜

### Prometheus é…ç½®

**æ–‡ä»¶ä½ç½®**: `prometheus/prometheus.yml`

ä¸»è¦é…ç½®é¡¹ï¼š
- `global.scrape_interval`: å…¨å±€æŠ“å–é—´éš” (é»˜è®¤ 15s)
- `global.evaluation_interval`: è§„åˆ™è¯„ä¼°é—´éš” (é»˜è®¤ 15s)
- `scrape_configs`: æŠ“å–ç›®æ ‡é…ç½®
- `rule_files`: å‘Šè­¦è§„åˆ™æ–‡ä»¶

### Grafana é…ç½®

**æ•°æ®æºé…ç½®**: `grafana/datasources/prometheus.yml`
**ä»ªè¡¨æ¿é…ç½®**: `grafana/dashboards/`

é»˜è®¤ä»ªè¡¨æ¿ï¼š
- **SmellPin ç³»ç»Ÿæ¦‚è§ˆ**: æ•´ä½“ç³»ç»ŸçŠ¶æ€å’Œå…³é”®æŒ‡æ ‡
- **SmellPin ä¸šåŠ¡ç›‘æ§**: ä¸šåŠ¡æ•°æ®å’Œç”¨æˆ·è¡Œä¸º
- **ç³»ç»Ÿèµ„æºç›‘æ§**: æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ

### AlertManager é…ç½®

**æ–‡ä»¶ä½ç½®**: `alertmanager/alertmanager.yml`

é…ç½®é¡¹è¯´æ˜ï¼š
- `global`: å…¨å±€é…ç½® (SMTP ç­‰)
- `route`: å‘Šè­¦è·¯ç”±è§„åˆ™
- `receivers`: å‘Šè­¦æ¥æ”¶å™¨é…ç½®
- `inhibit_rules`: å‘Šè­¦æŠ‘åˆ¶è§„åˆ™

## ç›‘æ§æŒ‡æ ‡

### ç³»ç»ŸæŒ‡æ ‡

| æŒ‡æ ‡åç§° | æè¿° | æ ‡ç­¾ |
|---------|------|------|
| `http_requests_total` | HTTP è¯·æ±‚æ€»æ•° | method, status, endpoint |
| `http_request_duration_seconds` | HTTP è¯·æ±‚æŒç»­æ—¶é—´ | method, status, endpoint |
| `system_cpu_usage` | CPU ä½¿ç”¨ç‡ | - |
| `system_memory_usage` | å†…å­˜ä½¿ç”¨ç‡ | - |
| `database_connections_active` | æ´»è·ƒæ•°æ®åº“è¿æ¥æ•° | - |
| `redis_connected_clients` | Redis è¿æ¥æ•° | - |

### ä¸šåŠ¡æŒ‡æ ‡

| æŒ‡æ ‡åç§° | æè¿° | æ ‡ç­¾ |
|---------|------|------|
| `user_registrations_total` | ç”¨æˆ·æ³¨å†Œæ€»æ•° | - |
| `annotations_created_total` | æ ‡æ³¨åˆ›å»ºæ€»æ•° | category, location |
| `payments_total` | æ”¯ä»˜æ€»æ•° | status, method |
| `lbs_rewards_distributed_total` | LBS å¥–åŠ±å‘æ”¾æ€»æ•° | - |
| `websocket_connections_active` | æ´»è·ƒ WebSocket è¿æ¥æ•° | - |

## å‘Šè­¦è§„åˆ™

### ç³»ç»Ÿå‘Šè­¦

- **æœåŠ¡å®•æœº**: æœåŠ¡æ— å“åº”è¶…è¿‡ 1 åˆ†é’Ÿ
- **é«˜é”™è¯¯ç‡**: 5xx é”™è¯¯ç‡è¶…è¿‡ 5%
- **å“åº”æ—¶é—´æ…¢**: 95% å“åº”æ—¶é—´è¶…è¿‡ 1 ç§’
- **CPU ä½¿ç”¨ç‡é«˜**: CPU ä½¿ç”¨ç‡è¶…è¿‡ 80%
- **å†…å­˜ä½¿ç”¨ç‡é«˜**: å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 85%

### ä¸šåŠ¡å‘Šè­¦

- **ç”¨æˆ·æ³¨å†Œéª¤é™**: 1 å°æ—¶å†…æ³¨å†Œæ•°ä½äºæ­£å¸¸å€¼ 50%
- **æ ‡æ³¨åˆ›å»ºå¼‚å¸¸**: 1 å°æ—¶å†…æ ‡æ³¨åˆ›å»ºæ•°å¼‚å¸¸
- **æ”¯ä»˜å¤±è´¥ç‡é«˜**: æ”¯ä»˜å¤±è´¥ç‡è¶…è¿‡ 10%
- **LBS å¥–åŠ±å¼‚å¸¸**: LBS å¥–åŠ±å‘æ”¾å¼‚å¸¸

### å®‰å…¨å‘Šè­¦

- **å¯ç–‘ç™»å½•**: çŸ­æ—¶é—´å†…å¤§é‡ç™»å½•å¤±è´¥
- **é™æµè§¦å‘**: é™æµè§¦å‘æ¬¡æ•°è¿‡å¤š
- **å¼‚å¸¸è®¿é—®**: å¼‚å¸¸ IP è®¿é—®æ¨¡å¼

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **æœåŠ¡æ— æ³•å¯åŠ¨**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tulpn | grep :9090
   
   # æ£€æŸ¥ Docker çŠ¶æ€
   docker ps -a
   
   # æŸ¥çœ‹æœåŠ¡æ—¥å¿—
   ./deploy.sh logs prometheus
   ```

2. **æ•°æ®æºè¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   docker exec -it smellpin-grafana ping prometheus
   
   # æ£€æŸ¥ Prometheus çŠ¶æ€
   curl http://localhost:9090/-/healthy
   ```

3. **å‘Šè­¦ä¸ç”Ÿæ•ˆ**
   ```bash
   # æ£€æŸ¥å‘Šè­¦è§„åˆ™
   curl http://localhost:9090/api/v1/rules
   
   # æ£€æŸ¥ AlertManager é…ç½®
   curl http://localhost:9093/api/v1/status
   ```

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f prometheus
docker-compose logs -f grafana
docker-compose logs -f alertmanager

# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
docker-compose logs --tail=100 prometheus
```

## æ€§èƒ½ä¼˜åŒ–

### Prometheus ä¼˜åŒ–

1. **å­˜å‚¨ä¼˜åŒ–**
   - è°ƒæ•´æ•°æ®ä¿ç•™æ—¶é—´: `--storage.tsdb.retention.time=30d`
   - é…ç½®å­˜å‚¨å‹ç¼©: `--storage.tsdb.wal-compression`

2. **æŸ¥è¯¢ä¼˜åŒ–**
   - ä½¿ç”¨è®°å½•è§„åˆ™é¢„è®¡ç®—å¤æ‚æŸ¥è¯¢
   - åˆç†è®¾ç½®æŠ“å–é—´éš”
   - é¿å…é«˜åŸºæ•°æ ‡ç­¾

### Grafana ä¼˜åŒ–

1. **ä»ªè¡¨æ¿ä¼˜åŒ–**
   - å‡å°‘é¢æ¿æ•°é‡
   - ä½¿ç”¨åˆé€‚çš„æ—¶é—´èŒƒå›´
   - å¯ç”¨æŸ¥è¯¢ç¼“å­˜

2. **æ•°æ®æºä¼˜åŒ–**
   - é…ç½®è¿æ¥æ± 
   - è®¾ç½®æŸ¥è¯¢è¶…æ—¶
   - ä½¿ç”¨ä»£ç†æ¨¡å¼

## å®‰å…¨é…ç½®

### è®¿é—®æ§åˆ¶

1. **Grafana å®‰å…¨**
   ```bash
   # ä¿®æ”¹é»˜è®¤å¯†ç 
   docker exec -it smellpin-grafana grafana-cli admin reset-admin-password newpassword
   
   # å¯ç”¨ HTTPS
   # åœ¨ docker-compose.yml ä¸­é…ç½® SSL è¯ä¹¦
   ```

2. **Prometheus å®‰å…¨**
   - é…ç½®åŸºæœ¬è®¤è¯
   - é™åˆ¶ç½‘ç»œè®¿é—®
   - ä½¿ç”¨ TLS åŠ å¯†

### ç½‘ç»œå®‰å…¨

```yaml
# docker-compose.yml ç½‘ç»œé…ç½®ç¤ºä¾‹
networks:
  monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

## å¤‡ä»½ä¸æ¢å¤

### æ•°æ®å¤‡ä»½

```bash
# å¤‡ä»½ Prometheus æ•°æ®
docker run --rm -v monitoring_prometheus_data:/data -v $(pwd):/backup alpine tar czf /backup/prometheus-backup.tar.gz /data

# å¤‡ä»½ Grafana æ•°æ®
docker run --rm -v monitoring_grafana_data:/data -v $(pwd):/backup alpine tar czf /backup/grafana-backup.tar.gz /data
```

### æ•°æ®æ¢å¤

```bash
# æ¢å¤ Prometheus æ•°æ®
docker run --rm -v monitoring_prometheus_data:/data -v $(pwd):/backup alpine tar xzf /backup/prometheus-backup.tar.gz -C /

# æ¢å¤ Grafana æ•°æ®
docker run --rm -v monitoring_grafana_data:/data -v $(pwd):/backup alpine tar xzf /backup/grafana-backup.tar.gz -C /
```

## æ‰©å±•åŠŸèƒ½

### æ·»åŠ æ–°çš„ç›‘æ§ç›®æ ‡

1. **ä¿®æ”¹ Prometheus é…ç½®**
   ```yaml
   # prometheus/prometheus.yml
   scrape_configs:
     - job_name: 'new-service'
       static_configs:
         - targets: ['new-service:port']
   ```

2. **é‡æ–°åŠ è½½é…ç½®**
   ```bash
   curl -X POST http://localhost:9090/-/reload
   ```

### è‡ªå®šä¹‰ä»ªè¡¨æ¿

1. **å¯¼å‡ºç°æœ‰ä»ªè¡¨æ¿**
   - åœ¨ Grafana ä¸­å¯¼å‡º JSON é…ç½®
   - ä¿å­˜åˆ° `grafana/dashboards/` ç›®å½•

2. **åˆ›å»ºæ–°ä»ªè¡¨æ¿**
   - ä½¿ç”¨ Grafana UI åˆ›å»º
   - æˆ–ç›´æ¥ç¼–å†™ JSON é…ç½®æ–‡ä»¶

## ç»´æŠ¤æŒ‡å—

### å®šæœŸç»´æŠ¤ä»»åŠ¡

1. **æ¯æ—¥æ£€æŸ¥**
   - æœåŠ¡å¥åº·çŠ¶æ€
   - å‘Šè­¦çŠ¶æ€
   - ç£ç›˜ç©ºé—´ä½¿ç”¨

2. **æ¯å‘¨ç»´æŠ¤**
   - æ¸…ç†è¿‡æœŸæ•°æ®
   - æ›´æ–°ç›‘æ§è§„åˆ™
   - æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡

3. **æ¯æœˆç»´æŠ¤**
   - å¤‡ä»½ç›‘æ§æ•°æ®
   - æ›´æ–°æœåŠ¡ç‰ˆæœ¬
   - ä¼˜åŒ–é…ç½®å‚æ•°

### ç›‘æ§ç³»ç»Ÿç›‘æ§

```bash
# ç›‘æ§ Prometheus è‡ªèº«
curl http://localhost:9090/metrics | grep prometheus_

# ç›‘æ§ Grafana çŠ¶æ€
curl http://localhost:3001/api/health

# ç›‘æ§ AlertManager çŠ¶æ€
curl http://localhost:9093/api/v1/status
```

## è”ç³»æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬ï¼š

- **æŠ€æœ¯æ”¯æŒ**: tech@smellpin.com
- **é—®é¢˜åé¦ˆ**: https://github.com/smellpin/issues
- **æ–‡æ¡£æ›´æ–°**: docs@smellpin.com

---

**ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**ç»´æŠ¤å›¢é˜Ÿ**: SmellPin DevOps Team