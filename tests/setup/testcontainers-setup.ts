/**\n * SmellPin Testcontainers è®¾ç½® - Phase 1\n * ç”¨çœŸå®çš„ Postgres + PostGIS + Redis æ›¿ä»£ SQLite\n * è§£å†³ LBS/åœ°ç†å›´æ /è¿‘é‚»æŸ¥è¯¢çš„è¡Œä¸ºå·®å¼‚é—®é¢˜\n */\nimport { GenericContainer, StartedTestContainer, Wait } from 'testcontainers';\nimport { Client } from 'pg';\nimport Redis from 'ioredis';\n\ninterface TestEnvironment {\n  postgres: StartedTestContainer;\n  redis: StartedTestContainer;\n  pgClient: Client;\n  redisClient: Redis;\n  DATABASE_URL: string;\n  REDIS_URL: string;\n}\n\nclass TestContainersManager {\n  private static instance: TestContainersManager;\n  private environment: TestEnvironment | null = null;\n  private isSetup = false;\n\n  static getInstance(): TestContainersManager {\n    if (!TestContainersManager.instance) {\n      TestContainersManager.instance = new TestContainersManager();\n    }\n    return TestContainersManager.instance;\n  }\n\n  async setupTestEnvironment(): Promise<TestEnvironment> {\n    if (this.isSetup && this.environment) {\n      return this.environment;\n    }\n\n    console.log('ğŸ³ å¯åŠ¨ Testcontainers: Postgres + PostGIS + Redis...');\n    \n    try {\n      // å¯åŠ¨ PostgreSQL + PostGIS å®¹å™¨\n      const postgresContainer = await new GenericContainer('postgis/postgis:16-3.4')\n        .withEnvironment({\n          POSTGRES_DB: 'smellpin_test',\n          POSTGRES_USER: 'test_user', \n          POSTGRES_PASSWORD: 'test_password',\n          POSTGRES_INITDB_ARGS: '--encoding=UTF-8 --lc-collate=C --lc-ctype=C'\n        })\n        .withExposedPorts(5432)\n        .withWaitStrategy(Wait.forLogMessage('database system is ready to accept connections', 2))\n        .withStartupTimeout(60000)\n        .start();\n\n      console.log(`âœ… PostgreSQL + PostGIS å¯åŠ¨æˆåŠŸ: ${postgresContainer.getMappedPort(5432)}`);\n\n      // å¯åŠ¨ Redis å®¹å™¨\n      const redisContainer = await new GenericContainer('redis:7-alpine')\n        .withExposedPorts(6379)\n        .withWaitStrategy(Wait.forLogMessage('Ready to accept connections'))\n        .withStartupTimeout(30000)\n        .start();\n\n      console.log(`âœ… Redis å¯åŠ¨æˆåŠŸ: ${redisContainer.getMappedPort(6379)}`);\n\n      // åˆ›å»ºæ•°æ®åº“è¿æ¥\n      const DATABASE_URL = `postgres://test_user:test_password@localhost:${postgresContainer.getMappedPort(5432)}/smellpin_test`;\n      const REDIS_URL = `redis://localhost:${redisContainer.getMappedPort(6379)}`;\n\n      const pgClient = new Client({ connectionString: DATABASE_URL });\n      await pgClient.connect();\n\n      const redisClient = new Redis(REDIS_URL);\n      await redisClient.ping();\n\n      // åˆå§‹åŒ– PostGIS æ‰©å±•\n      await this.initializePostGIS(pgClient);\n\n      // è¿è¡Œæ•°æ®åº“è¿ç§»\n      await this.runMigrations(DATABASE_URL);\n\n      this.environment = {\n        postgres: postgresContainer,\n        redis: redisContainer,\n        pgClient,\n        redisClient,\n        DATABASE_URL,\n        REDIS_URL\n      };\n\n      // è®¾ç½®ç¯å¢ƒå˜é‡\n      process.env.DATABASE_URL = DATABASE_URL;\n      process.env.REDIS_URL = REDIS_URL;\n      process.env.NODE_ENV = 'test';\n\n      this.isSetup = true;\n      console.log('ğŸ‰ æµ‹è¯•ç¯å¢ƒå‡†å¤‡å®Œæˆ!');\n      \n      return this.environment;\n      \n    } catch (error) {\n      console.error('âŒ Testcontainers å¯åŠ¨å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  private async initializePostGIS(client: Client): Promise<void> {\n    console.log('ğŸ—ºï¸ åˆå§‹åŒ– PostGIS æ‰©å±•...');\n    \n    try {\n      // å¯ç”¨ PostGIS æ‰©å±•\n      await client.query('CREATE EXTENSION IF NOT EXISTS postgis;');\n      await client.query('CREATE EXTENSION IF NOT EXISTS postgis_topology;');\n      await client.query('CREATE EXTENSION IF NOT EXISTS postgis_tiger_geocoder;');\n      await client.query('CREATE EXTENSION IF NOT EXISTS fuzzystrmatch;');\n      \n      // éªŒè¯ PostGIS å®‰è£…\n      const result = await client.query('SELECT PostGIS_Version();');\n      console.log(`âœ… PostGIS ç‰ˆæœ¬: ${result.rows[0].postgis_version}`);\n      \n    } catch (error) {\n      console.error('âŒ PostGIS åˆå§‹åŒ–å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  private async runMigrations(databaseUrl: string): Promise<void> {\n    console.log('ğŸ“¦ è¿è¡Œæ•°æ®åº“è¿ç§»...');\n    \n    try {\n      const knex = require('knex')({\n        client: 'pg',\n        connection: databaseUrl,\n        migrations: {\n          directory: './migrations',\n          extension: 'js'\n        },\n        seeds: {\n          directory: './seeds'\n        }\n      });\n\n      await knex.migrate.latest();\n      console.log('âœ… æ•°æ®åº“è¿ç§»å®Œæˆ');\n      \n      await knex.destroy();\n    } catch (error) {\n      console.error('âŒ æ•°æ®åº“è¿ç§»å¤±è´¥:', error);\n      throw error;\n    }\n  }\n\n  async teardownTestEnvironment(): Promise<void> {\n    if (!this.environment) {\n      return;\n    }\n\n    console.log('ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ...');\n\n    try {\n      // å…³é—­æ•°æ®åº“è¿æ¥\n      if (this.environment.pgClient) {\n        await this.environment.pgClient.end();\n      }\n\n      if (this.environment.redisClient) {\n        await this.environment.redisClient.disconnect();\n      }\n\n      // åœæ­¢å®¹å™¨\n      await this.environment.postgres.stop();\n      await this.environment.redis.stop();\n\n      this.environment = null;\n      this.isSetup = false;\n      \n      console.log('âœ… æµ‹è¯•ç¯å¢ƒæ¸…ç†å®Œæˆ');\n    } catch (error) {\n      console.error('âŒ æµ‹è¯•ç¯å¢ƒæ¸…ç†å¤±è´¥:', error);\n    }\n  }\n\n  getEnvironment(): TestEnvironment | null {\n    return this.environment;\n  }\n\n  // æ•°æ®éš”ç¦» - æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„ schema\n  async createIsolatedSchema(testName: string): Promise<string> {\n    if (!this.environment?.pgClient) {\n      throw new Error('æµ‹è¯•ç¯å¢ƒæœªåˆå§‹åŒ–');\n    }\n\n    const schemaName = `test_${testName}_${Date.now()}`;\n    await this.environment.pgClient.query(`CREATE SCHEMA IF NOT EXISTS \"${schemaName}\";`);\n    await this.environment.pgClient.query(`SET search_path TO \"${schemaName}\", public;`);\n    \n    return schemaName;\n  }\n\n  async dropIsolatedSchema(schemaName: string): Promise<void> {\n    if (!this.environment?.pgClient) {\n      return;\n    }\n\n    try {\n      await this.environment.pgClient.query(`DROP SCHEMA IF EXISTS \"${schemaName}\" CASCADE;`);\n    } catch (error) {\n      console.warn(`æ¸…ç† schema ${schemaName} å¤±è´¥:`, error);\n    }\n  }\n\n  // Redis æ¸…ç† - ä½¿ç”¨ä¸åŒçš„ DB ç´¢å¼•éš”ç¦»æµ‹è¯•æ•°æ®\n  async getIsolatedRedis(dbIndex: number = 0): Promise<Redis> {\n    if (!this.environment?.REDIS_URL) {\n      throw new Error('Redis ç¯å¢ƒæœªåˆå§‹åŒ–');\n    }\n\n    const redis = new Redis(`${this.environment.REDIS_URL}/${dbIndex}`);\n    await redis.flushdb(); // æ¸…ç©ºå½“å‰æ•°æ®åº“\n    return redis;\n  }\n}\n\n// å…¨å±€è®¾ç½®å’Œæ¸…ç†å‡½æ•°\nexport async function setupTestContainers(): Promise<TestEnvironment> {\n  const manager = TestContainersManager.getInstance();\n  return await manager.setupTestEnvironment();\n}\n\nexport async function teardownTestContainers(): Promise<void> {\n  const manager = TestContainersManager.getInstance();\n  await manager.teardownTestEnvironment();\n}\n\nexport function getTestEnvironment(): TestEnvironment | null {\n  const manager = TestContainersManager.getInstance();\n  return manager.getEnvironment();\n}\n\n// Jest å…¨å±€è®¾ç½®å‡½æ•°\nexport default async function globalSetup() {\n  console.log('ğŸš€ å…¨å±€æµ‹è¯•ç¯å¢ƒè®¾ç½®å¼€å§‹...');\n  await setupTestContainers();\n  console.log('âœ… å…¨å±€æµ‹è¯•ç¯å¢ƒè®¾ç½®å®Œæˆ');\n}\n\n// Jest å…¨å±€æ¸…ç†å‡½æ•° \nexport async function globalTeardown() {\n  console.log('ğŸ§¹ å…¨å±€æµ‹è¯•ç¯å¢ƒæ¸…ç†å¼€å§‹...');\n  await teardownTestContainers();\n  console.log('âœ… å…¨å±€æµ‹è¯•ç¯å¢ƒæ¸…ç†å®Œæˆ');\n}\n\n// å¯¼å‡ºç®¡ç†å™¨å®ä¾‹ä¾›æµ‹è¯•ä½¿ç”¨\nexport { TestContainersManager };