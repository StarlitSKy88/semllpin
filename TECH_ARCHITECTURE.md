# SmellPin æç¬‘æ¶æå¹³å°æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨å±‚     â”‚    â”‚   ç§»åŠ¨ç«¯åº”ç”¨     â”‚    â”‚   ç®¡ç†åå°       â”‚
â”‚   (React PWA)   â”‚    â”‚   (React Native)â”‚    â”‚   (React Admin) â”‚
â”‚   æç¬‘UIè®¾è®¡     â”‚    â”‚   æ ¡å›­ç¤¾äº¤ç‰ˆ     â”‚    â”‚   å†…å®¹å®¡æ ¸ç®¡ç†   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APIç½‘å…³ + CDN                             â”‚
â”‚                    (Kong/Nginx + CloudFlare)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å¾®æœåŠ¡å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç”¨æˆ·æœåŠ¡    â”‚ â”‚ æ¶ææ ‡æ³¨æœåŠ¡ â”‚ â”‚ é€æ˜æ”¯ä»˜æœåŠ¡ â”‚ â”‚  é€šçŸ¥æœåŠ¡    â”‚  â”‚
â”‚  â”‚ (Node.js)   â”‚ â”‚ (Node.js)   â”‚ â”‚ (Node.js)   â”‚ â”‚ (Node.js)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ LBSå¥–åŠ±æœåŠ¡ â”‚ â”‚ æç¬‘åˆ†ææœåŠ¡ â”‚ â”‚ åª’ä½“æ–‡ä»¶æœåŠ¡ â”‚ â”‚ ç¤¾äº¤åˆ†äº«æœåŠ¡ â”‚  â”‚
â”‚  â”‚ (Node.js)   â”‚ â”‚ (Python)    â”‚ â”‚ (Node.js)   â”‚ â”‚ (Node.js)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å›½é™…åŒ–æœåŠ¡   â”‚ â”‚ å†…å®¹å®¡æ ¸æœåŠ¡ â”‚ â”‚ å®æ—¶åŠ¨ç”»æœåŠ¡ â”‚ â”‚ æ ¡å›­æ¨å¹¿æœåŠ¡ â”‚  â”‚
â”‚  â”‚ (Node.js)   â”‚ â”‚ (Python)    â”‚ â”‚ (Node.js)   â”‚ â”‚ (Node.js)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ•°æ®å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PostgreSQL  â”‚ â”‚    Redis    â”‚ â”‚ Elasticsearchâ”‚ â”‚   MongoDB   â”‚  â”‚
â”‚  â”‚ (ä¸»æ•°æ®åº“+   â”‚ â”‚ (ç¼“å­˜+å®æ—¶   â”‚ â”‚ (æç¬‘å†…å®¹    â”‚ â”‚ (æ—¥å¿—+åˆ†æ   â”‚  â”‚
â”‚  â”‚  PostGIS)   â”‚ â”‚  åŠ¨ç”»æ•°æ®)   â”‚ â”‚  æœç´¢å¼•æ“)   â”‚ â”‚  æ•°æ®å­˜å‚¨)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆé€‰æ‹©

#### å‰ç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**ï¼šReact 18 + TypeScript
- **çŠ¶æ€ç®¡ç†**ï¼šRedux Toolkit + RTK Query
- **UIç»„ä»¶åº“**ï¼šAnt Design + Tailwind CSS + Framer Motionï¼ˆåŠ¨ç”»ï¼‰
- **åœ°å›¾ç»„ä»¶**ï¼šReact Google Maps API + Mapbox GL JS
- **å›¾è¡¨åº“**ï¼šChart.js + D3.js + React Springï¼ˆåŠ¨ç”»å›¾è¡¨ï¼‰
- **åŠ¨ç”»åº“**ï¼šFramer Motion + Lottie Reactï¼ˆæç¬‘åŠ¨ç”»ï¼‰
- **ç¤¾äº¤åˆ†äº«**ï¼šReact Share + Web Share API
- **å›½é™…åŒ–**ï¼šReact i18next
- **PWAæ”¯æŒ**ï¼šWorkbox + React PWA
- **æ„å»ºå·¥å…·**ï¼šVite + PWA Plugin
- **æµ‹è¯•æ¡†æ¶**ï¼šJest + React Testing Library + Playwrightï¼ˆE2Eï¼‰
- **æ€§èƒ½ç›‘æ§**ï¼šWeb Vitals + Sentry

#### åç«¯æŠ€æœ¯æ ˆ
- **è¿è¡Œæ—¶**ï¼šNode.js 18+ (ä¸»è¦æœåŠ¡) + Python 3.11 (å†…å®¹åˆ†ææœåŠ¡)
- **æ¡†æ¶**ï¼šExpress.js + FastAPI + Socket.ioï¼ˆå®æ—¶åŠŸèƒ½ï¼‰
- **æ•°æ®åº“**ï¼šPostgreSQL 15 + PostGIS (åœ°ç†æ•°æ®)
- **ç¼“å­˜**ï¼šRedis 7 + Redis Streamsï¼ˆå®æ—¶åŠ¨ç”»æ•°æ®ï¼‰
- **æœç´¢å¼•æ“**ï¼šElasticsearch 8ï¼ˆæç¬‘å†…å®¹æœç´¢ï¼‰
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šRedis + Bull Queue + WebSocket
- **æ”¯ä»˜é›†æˆ**ï¼šStripe + PayPal + Apple Pay/Google Pay
- **ç¤¾äº¤åˆ†äº«**ï¼šTwitter API + Instagram Basic Display API
- **æ–‡ä»¶å­˜å‚¨**ï¼šAWS S3 / CloudFlare R2ï¼ˆåª’ä½“æ–‡ä»¶CDNï¼‰
- **å›½é™…åŒ–**ï¼ši18next + ICU MessageFormat
- **å†…å®¹å®¡æ ¸**ï¼šOpenAI Moderation API + è‡ªå®šä¹‰è§„åˆ™å¼•æ“
- **ç›‘æ§**ï¼šPrometheus + Grafana + Sentry

#### DevOpsæŠ€æœ¯æ ˆ
- **å®¹å™¨åŒ–**ï¼šDocker + Docker Compose
- **ç¼–æ’**ï¼šKubernetes
- **CI/CD**ï¼šGitHub Actions
- **äº‘æœåŠ¡**ï¼šAWS / é˜¿é‡Œäº‘
- **CDN**ï¼šCloudFlare
- **æ—¥å¿—**ï¼šELK Stack (Elasticsearch + Logstash + Kibana)

## 2. æ•°æ®åº“è®¾è®¡

### 2.1 PostgreSQL ä¸»æ•°æ®åº“

#### ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    phone VARCHAR(20) UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    username VARCHAR(50) UNIQUE NOT NULL,
    display_name VARCHAR(100),
    avatar_url TEXT,
    bio TEXT,
    balance DECIMAL(10,2) DEFAULT 0.00, -- ç”¨æˆ·ä½™é¢
    total_earned DECIMAL(10,2) DEFAULT 0.00, -- æ€»æ”¶å…¥ï¼ˆLBSå¥–åŠ±ï¼‰
    total_spent DECIMAL(10,2) DEFAULT 0.00, -- æ€»æ”¯å‡ºï¼ˆæ¶ææ ‡æ³¨ï¼‰
    points INTEGER DEFAULT 0, -- ç§¯åˆ†ç³»ç»Ÿ
    level INTEGER DEFAULT 1, -- ç”¨æˆ·ç­‰çº§
    prank_count INTEGER DEFAULT 0, -- æ¶ææ¬¡æ•°
    discovery_count INTEGER DEFAULT 0, -- å‘ç°æ¶ææ¬¡æ•°
    social_shares INTEGER DEFAULT 0, -- ç¤¾äº¤åˆ†äº«æ¬¡æ•°
    preferred_language VARCHAR(10) DEFAULT 'en', -- é¦–é€‰è¯­è¨€
    university VARCHAR(100), -- æ‰€åœ¨å¤§å­¦
    graduation_year INTEGER, -- æ¯•ä¸šå¹´ä»½
    status VARCHAR(20) DEFAULT 'active', -- active, suspended, deleted
    email_verified BOOLEAN DEFAULT false,
    phone_verified BOOLEAN DEFAULT false,
    is_premium BOOLEAN DEFAULT false, -- é«˜çº§ç”¨æˆ·
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_university ON users(university);
CREATE INDEX idx_users_level ON users(level);
```

#### æ¶ææ ‡æ³¨è¡¨ (annotations)
```sql
CREATE TABLE annotations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    location GEOGRAPHY(POINT, 4326) NOT NULL, -- PostGISåœ°ç†ä½ç½®
    latitude DECIMAL(10, 8) NOT NULL,
    longitude DECIMAL(11, 8) NOT NULL,
    smell_intensity INTEGER NOT NULL CHECK (smell_intensity >= 1 AND smell_intensity <= 10),
    paid_amount DECIMAL(10,2) NOT NULL CHECK (paid_amount >= 1.00 AND paid_amount <= 100.00), -- ä»˜è´¹é‡‘é¢
    description TEXT,
    funny_title VARCHAR(200), -- æç¬‘æ ‡é¢˜
    prank_type VARCHAR(50), -- æ¶æç±»å‹ï¼štoilet, garbage, food, mysteryç­‰
    emoji_reaction VARCHAR(10), -- è¡¨æƒ…ååº”
    weather_condition JSONB, -- å¤©æ°”ä¿¡æ¯
    address TEXT,
    country VARCHAR(2), -- ISOå›½å®¶ä»£ç 
    region VARCHAR(100),
    city VARCHAR(100),
    university VARCHAR(100), -- æ‰€åœ¨å¤§å­¦
    campus_area VARCHAR(100), -- æ ¡å›­åŒºåŸŸ
    status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected, hidden
    is_verified BOOLEAN DEFAULT false,
    verification_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    laugh_count INTEGER DEFAULT 0, -- æç¬‘ç‚¹èµæ•°
    share_count INTEGER DEFAULT 0, -- åˆ†äº«æ¬¡æ•°
    comment_count INTEGER DEFAULT 0,
    discovery_reward DECIMAL(10,2) DEFAULT 0.00, -- å‘ç°å¥–åŠ±
    viral_bonus DECIMAL(10,2) DEFAULT 0.00, -- ç—…æ¯’ä¼ æ’­å¥–åŠ±
    moderation_flags INTEGER DEFAULT 0, -- ä¸¾æŠ¥æ¬¡æ•°
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE -- æ ‡æ³¨è¿‡æœŸæ—¶é—´
);

CREATE INDEX idx_annotations_location ON annotations USING GIST(location);
CREATE INDEX idx_annotations_user_id ON annotations(user_id);
CREATE INDEX idx_annotations_intensity ON annotations(smell_intensity);
CREATE INDEX idx_annotations_paid_amount ON annotations(paid_amount);
CREATE INDEX idx_annotations_status ON annotations(status);
CREATE INDEX idx_annotations_university ON annotations(university);
CREATE INDEX idx_annotations_prank_type ON annotations(prank_type);
CREATE INDEX idx_annotations_created_at ON annotations(created_at);
CREATE INDEX idx_annotations_expires_at ON annotations(expires_at);
```

#### åª’ä½“æ–‡ä»¶è¡¨ (media_files)
```sql
CREATE TABLE media_files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    annotation_id UUID NOT NULL REFERENCES annotations(id) ON DELETE CASCADE,
    file_type VARCHAR(20) NOT NULL, -- image, video, audio
    file_url TEXT NOT NULL,
    file_size INTEGER,
    mime_type VARCHAR(100),
    width INTEGER, -- å›¾ç‰‡/è§†é¢‘å®½åº¦
    height INTEGER, -- å›¾ç‰‡/è§†é¢‘é«˜åº¦
    duration INTEGER, -- è§†é¢‘/éŸ³é¢‘æ—¶é•¿(ç§’)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_media_files_annotation_id ON media_files(annotation_id);
```

#### è¯„è®ºè¡¨ (comments)
```sql
CREATE TABLE comments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    annotation_id UUID NOT NULL REFERENCES annotations(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id),
    parent_id UUID REFERENCES comments(id), -- å›å¤è¯„è®º
    content TEXT NOT NULL,
    like_count INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active', -- active, deleted, hidden
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_comments_annotation_id ON comments(annotation_id);
CREATE INDEX idx_comments_user_id ON comments(user_id);
CREATE INDEX idx_comments_parent_id ON comments(parent_id);
```

#### é€æ˜æ”¯ä»˜è®°å½•è¡¨ (payments)
```sql
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    annotation_id UUID REFERENCES annotations(id),
    transaction_type VARCHAR(20) NOT NULL, -- prank_payment, lbs_reward, discovery_bonus, viral_bonus
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'USD',
    payment_method VARCHAR(50), -- stripe, paypal, apple_pay, google_pay
    payment_id TEXT, -- ç¬¬ä¸‰æ–¹æ”¯ä»˜ID
    platform_fee DECIMAL(10,2) DEFAULT 0.00, -- å¹³å°æ‰‹ç»­è´¹
    tax_amount DECIMAL(10,2) DEFAULT 0.00, -- ç¨è´¹
    net_amount DECIMAL(10,2) NOT NULL, -- å‡€é‡‘é¢
    status VARCHAR(20) DEFAULT 'pending', -- pending, completed, failed, refunded
    description TEXT,
    metadata JSONB, -- é¢å¤–ä¿¡æ¯ï¼ˆåœ°ç†ä½ç½®ã€å¥–åŠ±ç±»å‹ç­‰ï¼‰
    tax_year INTEGER, -- ç¨åŠ¡å¹´åº¦
    is_taxable BOOLEAN DEFAULT true, -- æ˜¯å¦éœ€è¦çº³ç¨
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE,
    refunded_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_payments_user_id ON payments(user_id);
CREATE INDEX idx_payments_transaction_type ON payments(transaction_type);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_tax_year ON payments(tax_year);
CREATE INDEX idx_payments_created_at ON payments(created_at);
```

### 2.2 Redis ç¼“å­˜è®¾è®¡

#### ç¼“å­˜ç­–ç•¥
```javascript
// ç”¨æˆ·ä¼šè¯ç¼“å­˜
`session:${sessionId}` -> { userId, expiresAt, language, ... }

// ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
`user:${userId}` -> { id, username, avatar, university, level, ... }

// æç¬‘æ ‡æ³¨ç¼“å­˜
`hot_pranks:${region}` -> [annotationId1, annotationId2, ...]
`trending_pranks:${university}` -> [annotationId1, annotationId2, ...]
`viral_pranks:global` -> [annotationId1, annotationId2, ...]

// åœ°å›¾åŒºåŸŸæ ‡æ³¨ç¼“å­˜
`map_annotations:${lat}:${lng}:${zoom}` -> [annotation1, annotation2, ...]
`campus_pranks:${university}:${area}` -> [annotation1, annotation2, ...]

// LBSå¥–åŠ±ç¼“å­˜
`lbs_rewards:${userId}:${date}` -> { totalRewards, locations, ... }
`nearby_users:${lat}:${lng}` -> [userId1, userId2, ...]

// å®æ—¶åŠ¨ç”»æ•°æ®ç¼“å­˜
`live_animations:${region}` -> [animationData1, animationData2, ...]
`smell_heatmap:${lat}:${lng}:${zoom}` -> heatmapData

// ç»Ÿè®¡æ•°æ®ç¼“å­˜
`stats:global` -> { totalPranks, activeUsers, totalRewards, ... }
`stats:daily:${date}` -> { newPranks, newUsers, rewardsGiven, ... }
`stats:university:${university}` -> { campusPranks, activeStudents, ... }

// ç¤¾äº¤åˆ†äº«ç¼“å­˜
`share_count:${annotationId}` -> shareCount
`viral_tracking:${annotationId}` -> { platforms, shares, clicks, ... }

// å›½é™…åŒ–ç¼“å­˜
`i18n:${language}:${version}` -> translationData

// é™æµç¼“å­˜
`rate_limit:${userId}:${action}` -> count
`rate_limit:${ip}:${action}` -> count
```

## 3. APIè®¾è®¡

### 3.1 RESTful APIè§„èŒƒ

#### åŸºç¡€URLç»“æ„
```
https://api.smellpin.com/v1/{resource}
```

#### è®¤è¯æ–¹å¼
```javascript
// JWT Tokenè®¤è¯
Authorization: Bearer <jwt_token>

// API Keyè®¤è¯ï¼ˆä¼ä¸šç”¨æˆ·ï¼‰
X-API-Key: <api_key>
```

#### å“åº”æ ¼å¼
```javascript
// æˆåŠŸå“åº”
{
  "success": true,
  "data": {...},
  "message": "æ“ä½œæˆåŠŸ",
  "timestamp": "2024-12-19T10:30:00Z"
}

// é”™è¯¯å“åº”
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥",
    "details": {
      "field": "email",
      "reason": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
    }
  },
  "timestamp": "2024-12-19T10:30:00Z"
}
```

### 3.2 æ ¸å¿ƒAPIæ¥å£

#### ç”¨æˆ·ç›¸å…³API
```javascript
// ç”¨æˆ·æ³¨å†Œ
POST /v1/auth/register
{
  "email": "user@example.com",
  "password": "password123",
  "username": "username",
  "university": "Stanford University",
  "graduation_year": 2025,
  "preferred_language": "en"
}

// ç”¨æˆ·ç™»å½•
POST /v1/auth/login
{
  "email": "user@example.com",
  "password": "password123"
}

// è·å–ç”¨æˆ·ä¿¡æ¯
GET /v1/users/me

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯
PUT /v1/users/me
{
  "display_name": "æç¬‘å¤§å¸ˆ",
  "bio": "ä¸“ä¸šæ¶æï¼Œå¿«ä¹è‡³ä¸Š",
  "university": "Harvard University",
  "preferred_language": "zh"
}

// è·å–ç”¨æˆ·ç»Ÿè®¡
GET /v1/users/me/stats
// è¿”å›ï¼š{ prank_count, discovery_count, total_earned, level, ... }

// è·å–ç”¨æˆ·é’±åŒ…
GET /v1/users/me/wallet
// è¿”å›ï¼š{ balance, total_earned, total_spent, recent_transactions, ... }
PUT /v1/users/me
{
  "display_name": "æ–°æ˜µç§°",
  "bio": "ä¸ªäººç®€ä»‹"
}
```

#### æ¶ææ ‡æ³¨ç›¸å…³API
```javascript
// åˆ›å»ºä»˜è´¹æ¶ææ ‡æ³¨
POST /v1/pranks
{
  "latitude": 37.4419,
  "longitude": -122.1430,
  "smell_intensity": 9,
  "paid_amount": 25.00,
  "funny_title": "é£Ÿå ‚ç¥ç§˜æ–™ç†ç°åœº",
  "description": "ä»Šå¤©çš„ç‰¹è‰²èœé—»èµ·æ¥åƒ...",
  "prank_type": "food",
  "emoji_reaction": "ğŸ¤¢",
  "university": "Stanford University",
  "campus_area": "Main Dining Hall",
  "media_files": ["funny_pic.jpg", "reaction_video.mp4"]
}

// è·å–æ¶ææ ‡æ³¨åˆ—è¡¨
GET /v1/pranks?lat=37.4419&lng=-122.1430&radius=1000&intensity_min=5&university=Stanford

// è·å–çƒ­é—¨æ¶æ
GET /v1/pranks/trending?university=Stanford&timeframe=week

// è·å–ç—…æ¯’ä¼ æ’­æ¶æ
GET /v1/pranks/viral?limit=20

// è·å–æ¶æè¯¦æƒ…
GET /v1/pranks/:id

// ç‚¹èµæ¶æ
POST /v1/pranks/:id/laugh

// åˆ†äº«æ¶æ
POST /v1/pranks/:id/share
{
  "platform": "twitter", // twitter, instagram, tiktok
  "message": "è¿™ä¸ªå¤ªæç¬‘äº†ï¼"
}

// ä¸¾æŠ¥æ¶æ
POST /v1/pranks/:id/report
{
  "reason": "inappropriate",
  "details": "å†…å®¹ä¸å½“"
}

// å‘ç°æ¶æï¼ˆè·å¾—å¥–åŠ±ï¼‰
POST /v1/pranks/:id/discover
```

#### æç¬‘åœ°å›¾ç›¸å…³API
```javascript
// è·å–åœ°å›¾æ¶ææ ‡æ³¨ï¼ˆæ”¯æŒèšåˆï¼‰
GET /v1/map/pranks?bounds=37.4,122.1,37.5,122.2&zoom=12&university=Stanford

// è·å–æç¬‘çƒ­åŠ›å›¾æ•°æ®
GET /v1/map/heatmap?bounds=37.4,122.1,37.5,122.2&type=smell_intensity

// è·å–å®æ—¶åŠ¨ç”»æ•°æ®
GET /v1/map/animations?bounds=37.4,122.1,37.5,122.2

// è·å–æ ¡å›­ç»Ÿè®¡
GET /v1/map/stats?university=Stanford&timeframe=week
// è¿”å›ï¼š{ total_pranks, avg_intensity, most_active_area, ... }

// è·å–æ’è¡Œæ¦œ
GET /v1/map/leaderboard?type=smelliest_spots&university=Stanford&limit=10
```

#### LBSå¥–åŠ±ç›¸å…³API
```javascript
// ç­¾åˆ°è·å–å¥–åŠ±
POST /v1/lbs/checkin
{
  "latitude": 37.4419,
  "longitude": -122.1430,
  "university": "Stanford University"
}

// è·å–é™„è¿‘ç”¨æˆ·
GET /v1/lbs/nearby?lat=37.4419&lng=-122.1430&radius=100

// è·å–å¥–åŠ±å†å²
GET /v1/lbs/rewards?user_id=me&timeframe=month
```

#### é€æ˜æ”¯ä»˜ç›¸å…³API
```javascript
// åˆ›å»ºæ”¯ä»˜è®¢å•
POST /v1/payments/create
{
  "amount": 25.00,
  "currency": "USD",
  "payment_method": "stripe",
  "transaction_type": "prank_payment",
  "prank_data": {
    "latitude": 37.4419,
    "longitude": -122.1430,
    "smell_intensity": 9
  }
}

// è·å–æ”¶æ”¯æ˜ç»†
GET /v1/payments/transactions?type=all&timeframe=month
// è¿”å›ï¼š{ payments, rewards, platform_fees, net_balance, ... }

// è·å–ç¨åŠ¡æŠ¥è¡¨
GET /v1/payments/tax-report?year=2024
```

#### ç¤¾äº¤åˆ†äº«ç›¸å…³API
```javascript
// ç”Ÿæˆåˆ†äº«é“¾æ¥
POST /v1/social/share-link
{
  "prank_id": "uuid",
  "platform": "twitter",
  "custom_message": "å¿«æ¥çœ‹è¿™ä¸ªæç¬‘çš„æ¶æï¼"
}

// è¿½è¸ªåˆ†äº«æ•ˆæœ
GET /v1/social/share-analytics/:prank_id
// è¿”å›ï¼š{ total_shares, platform_breakdown, click_through_rate, ... }

// è·å–ç—…æ¯’ä¼ æ’­æ•°æ®
GET /v1/social/viral-tracking/:prank_id
```

#### å›½é™…åŒ–ç›¸å…³API
```javascript
// è·å–ç¿»è¯‘æ–‡æœ¬
GET /v1/i18n/translations?lang=zh&version=latest

// åˆ‡æ¢è¯­è¨€
POST /v1/i18n/switch-language
{
  "language": "zh",
  "user_id": "uuid"
}

// è·å–æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
GET /v1/i18n/languages
```

#### å†…å®¹å®¡æ ¸ç›¸å…³API
```javascript
// ç®¡ç†å‘˜å®¡æ ¸æ¶æ
POST /v1/admin/moderate/:prank_id
{
  "action": "approve", // approve, reject, hide
  "reason": "ç¬¦åˆç¤¾åŒºè§„èŒƒ"
}

// è·å–å¾…å®¡æ ¸å†…å®¹
GET /v1/admin/pending-moderation?limit=20

// ç”¨æˆ·ä¸¾æŠ¥å¤„ç†
GET /v1/admin/reports?status=pending&limit=20

// è·å–ç”¨æˆ·ç®¡ç†æ•°æ®
GET /v1/admin/users?university=Stanford&status=active&limit=50

// ç¡®è®¤æ”¯ä»˜
POST /v1/payments/:id/confirm

// è·å–æ”¯ä»˜å†å²
GET /v1/payments/history
```

## 4. å®‰å…¨è®¾è®¡

### 4.1 è®¤è¯ä¸æˆæƒ

#### JWT Tokenè®¾è®¡
```javascript
// Tokenç»“æ„
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_id",
    "iat": 1640995200,
    "exp": 1641081600,
    "scope": ["read", "write"]
  }
}

// Tokenåˆ·æ–°æœºåˆ¶
- Access Token: 1å°æ—¶è¿‡æœŸ
- Refresh Token: 30å¤©è¿‡æœŸ
- è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
```

#### æƒé™æ§åˆ¶
```javascript
// è§’è‰²å®šä¹‰
const ROLES = {
  USER: 'user',           // æ™®é€šç”¨æˆ·
  MODERATOR: 'moderator', // ç‰ˆä¸»
  ADMIN: 'admin'          // ç®¡ç†å‘˜
};

// æƒé™å®šä¹‰
const PERMISSIONS = {
  CREATE_ANNOTATION: 'create:annotation',
  UPDATE_ANNOTATION: 'update:annotation',
  DELETE_ANNOTATION: 'delete:annotation',
  MODERATE_CONTENT: 'moderate:content',
  VIEW_ANALYTICS: 'view:analytics'
};
```

### 4.2 æ•°æ®å®‰å…¨

#### æ•æ„Ÿæ•°æ®åŠ å¯†
```javascript
// å¯†ç åŠ å¯†
const bcrypt = require('bcrypt');
const saltRounds = 12;
const hashedPassword = await bcrypt.hash(password, saltRounds);

// ä¸ªäººä¿¡æ¯åŠ å¯†
const crypto = require('crypto');
const algorithm = 'aes-256-gcm';
const key = process.env.ENCRYPTION_KEY;

function encrypt(text) {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipher(algorithm, key, iv);
  // ... åŠ å¯†é€»è¾‘
}
```

#### APIå®‰å…¨
```javascript
// é™æµé…ç½®
const rateLimit = {
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100, // æœ€å¤š100æ¬¡è¯·æ±‚
  message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
};

// CORSé…ç½®
const corsOptions = {
  origin: ['https://smellpin.com', 'https://app.smellpin.com'],
  credentials: true,
  optionsSuccessStatus: 200
};

// è¾“å…¥éªŒè¯
const Joi = require('joi');
const annotationSchema = Joi.object({
  latitude: Joi.number().min(-90).max(90).required(),
  longitude: Joi.number().min(-180).max(180).required(),
  smell_intensity: Joi.number().integer().min(1).max(10).required(),
  description: Joi.string().max(500).optional()
});
```

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•ç­–ç•¥
```sql
-- åœ°ç†ä½ç½®ç´¢å¼•ï¼ˆPostGISï¼‰
CREATE INDEX idx_annotations_location_gist ON annotations USING GIST(location);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_annotations_status_created ON annotations(status, created_at DESC);
CREATE INDEX idx_annotations_user_created ON annotations(user_id, created_at DESC);

-- éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_annotations_active ON annotations(created_at) WHERE status = 'approved';
```

#### æŸ¥è¯¢ä¼˜åŒ–
```sql
-- åœ°ç†ä½ç½®æŸ¥è¯¢ä¼˜åŒ–
SELECT id, latitude, longitude, smell_intensity
FROM annotations
WHERE ST_DWithin(
  location,
  ST_GeogFromText('POINT(116.4074 39.9042)'),
  1000  -- 1å…¬é‡ŒèŒƒå›´
)
AND status = 'approved'
ORDER BY created_at DESC
LIMIT 50;

-- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
SELECT *
FROM annotations
WHERE created_at < $1  -- æ¸¸æ ‡åˆ†é¡µ
ORDER BY created_at DESC
LIMIT 20;
```

### 5.2 ç¼“å­˜ç­–ç•¥

#### å¤šçº§ç¼“å­˜
```javascript
// L1: åº”ç”¨å†…å­˜ç¼“å­˜
const NodeCache = require('node-cache');
const memoryCache = new NodeCache({ stdTTL: 300 }); // 5åˆ†é’Ÿ

// L2: Redisç¼“å­˜
const redis = require('redis');
const redisClient = redis.createClient();

// L3: CDNç¼“å­˜
// CloudFlareç¼“å­˜é…ç½®
const cacheHeaders = {
  'Cache-Control': 'public, max-age=3600', // 1å°æ—¶
  'Vary': 'Accept-Encoding'
};

// ç¼“å­˜ç©¿é€é˜²æŠ¤
async function getAnnotationWithCache(id) {
  // 1. æ£€æŸ¥å†…å­˜ç¼“å­˜
  let annotation = memoryCache.get(`annotation:${id}`);
  if (annotation) return annotation;
  
  // 2. æ£€æŸ¥Redisç¼“å­˜
  annotation = await redisClient.get(`annotation:${id}`);
  if (annotation) {
    annotation = JSON.parse(annotation);
    memoryCache.set(`annotation:${id}`, annotation);
    return annotation;
  }
  
  // 3. æŸ¥è¯¢æ•°æ®åº“
  annotation = await db.annotations.findById(id);
  if (annotation) {
    await redisClient.setex(`annotation:${id}`, 3600, JSON.stringify(annotation));
    memoryCache.set(`annotation:${id}`, annotation);
  }
  
  return annotation;
}
```

### 5.3 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### ä»£ç åˆ†å‰²
```javascript
// è·¯ç”±çº§åˆ«ä»£ç åˆ†å‰²
const MapPage = lazy(() => import('./pages/MapPage'));
const ProfilePage = lazy(() => import('./pages/ProfilePage'));

// ç»„ä»¶çº§åˆ«ä»£ç åˆ†å‰²
const HeavyChart = lazy(() => import('./components/HeavyChart'));

// é¢„åŠ è½½å…³é”®èµ„æº
const preloadMapData = () => {
  import('./utils/mapUtils');
  import('./components/MapMarker');
};
```

#### å›¾ç‰‡ä¼˜åŒ–
```javascript
// å“åº”å¼å›¾ç‰‡
<picture>
  <source media="(max-width: 768px)" srcSet="image-mobile.webp" />
  <source media="(min-width: 769px)" srcSet="image-desktop.webp" />
  <img src="image-fallback.jpg" alt="æ ‡æ³¨å›¾ç‰‡" loading="lazy" />
</picture>

// å›¾ç‰‡å‹ç¼©å’Œæ ¼å¼è½¬æ¢
const sharp = require('sharp');

async function optimizeImage(inputBuffer) {
  return await sharp(inputBuffer)
    .resize(800, 600, { fit: 'inside', withoutEnlargement: true })
    .webp({ quality: 80 })
    .toBuffer();
}
```

## 6. ç›‘æ§ä¸æ—¥å¿—

### 6.1 åº”ç”¨ç›‘æ§

#### PrometheusæŒ‡æ ‡
```javascript
const prometheus = require('prom-client');

// è‡ªå®šä¹‰æŒ‡æ ‡
const httpRequestDuration = new prometheus.Histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTPè¯·æ±‚è€—æ—¶',
  labelNames: ['method', 'route', 'status']
});

const annotationCounter = new prometheus.Counter({
  name: 'annotations_total',
  help: 'æ ‡æ³¨æ€»æ•°',
  labelNames: ['country', 'intensity_level']
});

const activeUsers = new prometheus.Gauge({
  name: 'active_users',
  help: 'æ´»è·ƒç”¨æˆ·æ•°'
});
```

#### å¥åº·æ£€æŸ¥
```javascript
// å¥åº·æ£€æŸ¥ç«¯ç‚¹
app.get('/health', async (req, res) => {
  const health = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    services: {
      database: await checkDatabase(),
      redis: await checkRedis(),
      storage: await checkStorage()
    }
  };
  
  const isHealthy = Object.values(health.services).every(service => service.status === 'ok');
  
  res.status(isHealthy ? 200 : 503).json(health);
});
```

### 6.2 æ—¥å¿—ç³»ç»Ÿ

#### ç»“æ„åŒ–æ—¥å¿—
```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
});

// ä½¿ç”¨ç¤ºä¾‹
logger.info('ç”¨æˆ·åˆ›å»ºæ ‡æ³¨', {
  userId: 'uuid',
  annotationId: 'uuid',
  location: { lat: 39.9042, lng: 116.4074 },
  intensity: 8
});
```

## 7. éƒ¨ç½²æ¶æ„

### 7.1 Dockerå®¹å™¨åŒ–

#### Dockerfileç¤ºä¾‹
```dockerfile
# Node.jsæœåŠ¡
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

USER node

CMD ["npm", "start"]
```

#### Docker Compose
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@db:5432/smellpin
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis

  db:
    image: postgis/postgis:15-3.3
    environment:
      - POSTGRES_DB=smellpin
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### 7.2 Kuberneteséƒ¨ç½²

#### åº”ç”¨éƒ¨ç½²é…ç½®
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: smellpin-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: smellpin-api
  template:
    metadata:
      labels:
        app: smellpin-api
    spec:
      containers:
      - name: api
        image: smellpin/api:latest
        ports:
        - containerPort: 3000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: smellpin-secrets
              key: database-url
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2024å¹´12æœˆ  
**ç»´æŠ¤å›¢é˜Ÿ**ï¼šæŠ€æœ¯æ¶æ„ç»„