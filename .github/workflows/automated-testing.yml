name: ğŸ§ª SmellPin è‡ªåŠ¨åŒ–æµ‹è¯• CI/CD

on:
  push:
    branches: [ main, develop, 'feature/*', 'hotfix/*' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *' # æ¯æ—¥å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'full'
        type: choice
        options:
          - smoke
          - unit
          - integration
          - load
          - multi-agent
          - full
      test_environment:
        description: 'æµ‹è¯•ç¯å¢ƒ'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  
jobs:
  # é¢„å¤‡å·¥ä½œï¼šç¯å¢ƒæ£€æŸ¥å’Œä¾èµ–ç¼“å­˜
  prepare:
    name: 'ç¯å¢ƒå‡†å¤‡'
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-deps.outputs.cache-hit }}
      test-type: ${{ steps.determine-tests.outputs.test-type }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ç¼“å­˜ä¾èµ–
        id: cache-deps
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.npm
            ~/.cache
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: å®‰è£…ä¾èµ–
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          npm ci
          npm install -g artillery@latest

      - name: ç¡®å®šæµ‹è¯•ç±»å‹
        id: determine-tests
        run: |
          if [[ "${{ github.event.inputs.test_type }}" != "" ]]; then
            echo "test-type=${{ github.event.inputs.test_type }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "test-type=full" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "test-type=integration" >> $GITHUB_OUTPUT
          else
            echo "test-type=unit" >> $GITHUB_OUTPUT
          fi

      - name: éªŒè¯ä»£ç è´¨é‡
        run: |
          npm run lint
          npm run type-check
          npm run format:check

  # å†’çƒŸæµ‹è¯•ï¼šå¿«é€ŸéªŒè¯åŸºæœ¬åŠŸèƒ½
  smoke-test:
    name: 'å†’çƒŸæµ‹è¯•'
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.test-type == 'smoke' || needs.prepare.outputs.test-type == 'full'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: å¯åŠ¨æµ‹è¯•æœåŠ¡
        run: |
          chmod +x scripts/test-setup.sh
          ./scripts/test-setup.sh
        timeout-minutes: 5

      - name: ç­‰å¾…æœåŠ¡å°±ç»ª
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3001/health; do sleep 2; done'

      - name: è¿è¡Œå†’çƒŸæµ‹è¯•
        run: |
          npm install -g artillery@latest
          npm run artillery:smoke
        timeout-minutes: 5

      - name: æ¸…ç†æµ‹è¯•ç¯å¢ƒ
        if: always()
        run: |
          chmod +x scripts/test-teardown.sh
          ./scripts/test-teardown.sh

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: 'å•å…ƒæµ‹è¯•'
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.test-type == 'unit' || needs.prepare.outputs.test-type == 'integration' || needs.prepare.outputs.test-type == 'full'
    
    strategy:
      matrix:
        test-suite: [user-models, annotation-models, services, middleware, utils]
        
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: å¯åŠ¨æµ‹è¯•æ•°æ®åº“
        run: |
          docker-compose -f docker-compose.test.yml up -d postgres-test redis-test
          sleep 10

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          npm run test:unit
        env:
          NODE_ENV: test
          TEST_SUITE: ${{ matrix.test-suite }}

      - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unit-tests,${{ matrix.test-suite }}
          name: unit-coverage-${{ matrix.test-suite }}

      - name: æ¸…ç†
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down -v

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: 'é›†æˆæµ‹è¯•'
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.test-type == 'integration' || needs.prepare.outputs.test-type == 'full'
    
    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_DB: smellpin_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: æ¢å¤ä¾èµ–ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: è¿è¡Œæ•°æ®åº“è¿ç§»
        run: |
          npm run migrate:test
        env:
          TEST_DATABASE_URL: postgres://test:test@localhost:5433/smellpin_test

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          npm run test:integration
        env:
          NODE_ENV: test
          TEST_DATABASE_URL: postgres://test:test@localhost:5433/smellpin_test
          REDIS_URL: redis://localhost:6380

      - name: ä¸Šä¼ é›†æˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-report
          path: test-results/

  # å¹¶è¡Œæµ‹è¯•
  parallel-tests:
    name: 'å¹¶è¡Œæµ‹è¯•'
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.test-type == 'integration' || needs.prepare.outputs.test-type == 'full'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å¯åŠ¨å®Œæ•´æµ‹è¯•ç¯å¢ƒ
        run: |
          chmod +x scripts/test-setup.sh
          ./scripts/test-setup.sh

      - name: è¿è¡Œå¹¶è¡Œæµ‹è¯•å¥—ä»¶
        run: |
          npm run test:parallel
        env:
          NODE_ENV: test
          JEST_WORKERS: 4

      - name: ä¸Šä¼ å¹¶è¡Œæµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: parallel-test-report
          path: coverage/parallel/

      - name: æ¸…ç†æµ‹è¯•ç¯å¢ƒ
        if: always()
        run: |
          ./scripts/test-teardown.sh

  # Artilleryè´Ÿè½½æµ‹è¯•
  load-tests:
    name: 'Artilleryè´Ÿè½½æµ‹è¯•'
    runs-on: ubuntu-latest
    needs: [prepare, smoke-test]
    if: needs.prepare.outputs.test-type == 'load' || needs.prepare.outputs.test-type == 'full'
    
    strategy:
      matrix:
        test-type: [base-load, stress-test]
        
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…Artillery
        run: |
          npm install -g artillery@latest

      - name: å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
        run: |
          chmod +x scripts/test-setup.sh
          ./scripts/test-setup.sh
          
          # å¯åŠ¨åº”ç”¨æœåŠ¡å™¨
          npm run build
          NODE_ENV=test npm start &
          sleep 15

      - name: éªŒè¯æœåŠ¡å™¨çŠ¶æ€
        run: |
          curl -f http://localhost:3001/health
          curl -f http://localhost:3001/api/v1/health

      - name: è¿è¡ŒArtilleryè´Ÿè½½æµ‹è¯•
        run: |
          if [[ "${{ matrix.test-type }}" == "base-load" ]]; then
            npm run artillery:load
          elif [[ "${{ matrix.test-type }}" == "stress-test" ]]; then
            npm run artillery:stress
          fi
        timeout-minutes: 20

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        run: |
          if [[ -f "report.json" ]]; then
            artillery report report.json --output artillery-report-${{ matrix.test-type }}.html
          fi

      - name: ä¸Šä¼ ArtilleryæŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: artillery-report-${{ matrix.test-type }}
          path: |
            artillery-report-*.html
            report.json

      - name: æ¸…ç†
        if: always()
        run: |
          ./scripts/test-teardown.sh

  # å¤šAgentæ¨¡æ‹Ÿæµ‹è¯•
  multi-agent-tests:
    name: 'å¤šAgentæ¨¡æ‹Ÿæµ‹è¯•'
    runs-on: ubuntu-latest
    needs: [prepare, unit-tests]
    if: needs.prepare.outputs.test-type == 'multi-agent' || needs.prepare.outputs.test-type == 'full'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          npm install -g artillery@latest
          npm install @faker-js/faker

      - name: å¯åŠ¨å®Œæ•´æµ‹è¯•ç¯å¢ƒ
        run: |
          chmod +x scripts/test-setup.sh
          ./scripts/test-setup.sh
          
          # å¯åŠ¨åº”ç”¨æœåŠ¡å™¨
          npm run build
          NODE_ENV=test npm start &
          sleep 20

      - name: é¢„åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        run: |
          # åˆ›å»ºæµ‹è¯•ç”¨æˆ·ç”¨äºå¤šAgentæµ‹è¯•
          node -e "
            const axios = require('axios');
            const users = [
              {username: 'active1', email: 'active1@smellpin.test', password: 'Active123!'},
              {username: 'active2', email: 'active2@smellpin.test', password: 'Active123!'},
              {username: 'social1', email: 'social1@smellpin.test', password: 'Social123!'},
              {username: 'mobile1', email: 'mobile1@smellpin.test', password: 'Mobile123!'}
            ];
            
            Promise.all(users.map(user => 
              axios.post('http://localhost:3001/api/v1/users/register', user)
                .catch(err => console.log('User may already exist:', user.username))
            )).then(() => console.log('Test users created'));
          "

      - name: è¿è¡Œå¤šAgentæµ‹è¯•
        run: |
          npm run artillery:multi-agent
        timeout-minutes: 25
        env:
          MULTI_AGENT_MODE: true
          AGENT_SIMULATION: true

      - name: æ”¶é›†æ€§èƒ½æŒ‡æ ‡
        if: always()
        run: |
          # æ”¶é›†ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
          echo "=== ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ ===" > performance-metrics.txt
          echo "CPUä½¿ç”¨ç‡:" >> performance-metrics.txt
          top -bn1 | grep "Cpu(s)" >> performance-metrics.txt
          echo "å†…å­˜ä½¿ç”¨ç‡:" >> performance-metrics.txt
          free -h >> performance-metrics.txt
          echo "ç£ç›˜IO:" >> performance-metrics.txt
          iostat -x 1 1 >> performance-metrics.txt 2>/dev/null || echo "iostat not available"

      - name: ä¸Šä¼ å¤šAgentæµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: multi-agent-test-report
          path: |
            report.json
            performance-metrics.txt
            artillery-report-*.html

      - name: æ¸…ç†
        if: always()
        run: |
          ./scripts/test-teardown.sh

  # æµ‹è¯•æŠ¥å‘Šèšåˆ
  test-summary:
    name: 'æµ‹è¯•ç»“æœæ±‡æ€»'
    runs-on: ubuntu-latest
    needs: [smoke-test, unit-tests, integration-tests, parallel-tests, load-tests, multi-agent-tests]
    if: always()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•æŠ¥å‘Š
        uses: actions/download-artifact@v3
        with:
          path: test-reports/

      - name: ç”Ÿæˆæµ‹è¯•æ±‡æ€»æŠ¥å‘Š
        run: |
          echo "# SmellPin è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š" > TEST_SUMMARY.md
          echo "" >> TEST_SUMMARY.md
          echo "## æµ‹è¯•æ‰§è¡Œæ—¶é—´: $(date)" >> TEST_SUMMARY.md
          echo "" >> TEST_SUMMARY.md
          echo "## æµ‹è¯•ç»“æœæ¦‚è§ˆ" >> TEST_SUMMARY.md
          echo "" >> TEST_SUMMARY.md
          
          # æ£€æŸ¥å„ä¸ªæµ‹è¯•é˜¶æ®µçš„çŠ¶æ€
          echo "| æµ‹è¯•é˜¶æ®µ | çŠ¶æ€ | è¯¦æƒ… |" >> TEST_SUMMARY.md
          echo "|---------|------|------|" >> TEST_SUMMARY.md
          echo "| å†’çƒŸæµ‹è¯• | ${{ needs.smoke-test.result }} | å¿«é€ŸåŠŸèƒ½éªŒè¯ |" >> TEST_SUMMARY.md
          echo "| å•å…ƒæµ‹è¯• | ${{ needs.unit-tests.result }} | ä»£ç å•å…ƒéªŒè¯ |" >> TEST_SUMMARY.md
          echo "| é›†æˆæµ‹è¯• | ${{ needs.integration-tests.result }} | APIæ¥å£æµ‹è¯• |" >> TEST_SUMMARY.md
          echo "| å¹¶è¡Œæµ‹è¯• | ${{ needs.parallel-tests.result }} | å¹¶å‘æ€§èƒ½æµ‹è¯• |" >> TEST_SUMMARY.md
          echo "| è´Ÿè½½æµ‹è¯• | ${{ needs.load-tests.result }} | Artilleryå‹åŠ›æµ‹è¯• |" >> TEST_SUMMARY.md
          echo "| å¤šAgentæµ‹è¯• | ${{ needs.multi-agent-tests.result }} | ç”¨æˆ·è¡Œä¸ºæ¨¡æ‹Ÿ |" >> TEST_SUMMARY.md
          echo "" >> TEST_SUMMARY.md
          
          # ç»Ÿè®¡æµ‹è¯•æ–‡ä»¶
          echo "## æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶" >> TEST_SUMMARY.md
          find test-reports/ -name "*.html" -o -name "*.json" -o -name "*.xml" | while read file; do
            echo "- [$file]($file)" >> TEST_SUMMARY.md
          done

      - name: ä¸Šä¼ æµ‹è¯•æ±‡æ€»
        uses: actions/upload-artifact@v3
        with:
          name: test-summary
          path: |
            TEST_SUMMARY.md
            test-reports/

      - name: è¯„è®ºPRï¼ˆå¦‚æœæ˜¯PRï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('TEST_SUMMARY.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š\n\n${summary}`
            });

  # å¤±è´¥é€šçŸ¥
  notify-failure:
    name: 'å¤±è´¥é€šçŸ¥'
    runs-on: ubuntu-latest
    needs: [smoke-test, unit-tests, integration-tests, parallel-tests, load-tests, multi-agent-tests]
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: å‘é€é’‰é’‰é€šçŸ¥
        if: failure()
        run: |
          curl -X POST https://oapi.dingtalk.com/robot/send?access_token=${{ secrets.DINGTALK_TOKEN }} \
            -H 'Content-Type: application/json' \
            -d "{
              \"msgtype\": \"markdown\",
              \"markdown\": {
                \"title\": \"SmellPin æµ‹è¯•å¤±è´¥é€šçŸ¥\",
                \"text\": \"## ğŸš¨ SmellPin è‡ªåŠ¨åŒ–æµ‹è¯•å¤±è´¥\\n\\n**åˆ†æ”¯**: ${{ github.ref_name }}\\n**æäº¤**: ${{ github.sha }}\\n**è§¦å‘è€…**: ${{ github.actor }}\\n\\nè¯·æ£€æŸ¥æµ‹è¯•æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜ã€‚\"
              }
            }"