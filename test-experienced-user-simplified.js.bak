#!/usr/bin/env node

/**
 * SmellPin è€ç”¨æˆ·æ—¥å¸¸ä½¿ç”¨åœºæ™¯æµ‹è¯• - ç®€åŒ–ç‰ˆ
 * 
 * ç”¨æˆ·ç”»åƒï¼šæå¥³å£«ï¼Œ32å²ï¼ŒåŒ—äº¬å±…æ°‘
 * - ä½¿ç”¨ç»éªŒï¼šå·²ä½¿ç”¨SmellPin 2ä¸ªæœˆï¼Œåˆ›å»ºè¿‡5ä¸ªæ ‡æ³¨
 * - è®¾å¤‡ï¼šAndroidæ‰‹æœº + å®¶ç”¨MacBook
 * - ä½¿ç”¨ä¹ æƒ¯ï¼šæ¯å‘¨2-3æ¬¡ä½¿ç”¨ï¼Œä¸»è¦åœ¨é€šå‹¤è·¯ä¸Š
 */

const axios = require('axios');
const fs = require('fs').promises;

// æµ‹è¯•é…ç½®
const BASE_URL = 'http://localhost:3004/api/v1';
const FRONTEND_URL = 'http://localhost:3000';

// æµ‹è¯•ç”¨æˆ·ä¿¡æ¯
const testUser = {
  email: 'test@example.com', // ä½¿ç”¨å·²å­˜åœ¨çš„æµ‹è¯•ç”¨æˆ·
  password: 'password123',
  name: 'æå¥³å£«'
};

// æµ‹è¯•ç»“æœ
let results = {
  testName: 'è€ç”¨æˆ·æ—¥å¸¸ä½¿ç”¨åœºæ™¯æµ‹è¯•',
  userProfile: {
    name: 'æå¥³å£«',
    experience: '2ä¸ªæœˆ',
    usage: 'æ¯å‘¨2-3æ¬¡',
    device: 'Androidæ‰‹æœº'
  },
  startTime: new Date(),
  scenarios: {},
  summary: {
    loginExperience: 0,
    browsingExperience: 0,
    interactionExperience: 0,
    rewardExperience: 0,
    managementExperience: 0
  }
};

const logStep = (step, details = '') => {
  console.log(`[${new Date().toISOString()}] ${step}${details ? ': ' + details : ''}`);
};

const makeRequest = async (method, url, data = null, headers = {}) => {
  try {
    const config = { 
      method, 
      url, 
      timeout: 5000, 
      headers: {
        'Content-Type': 'application/json',
        ...headers
      }
    };
    if (data) config.data = data;
    
    const response = await axios(config);
    return { success: true, data: response.data, status: response.status };
  } catch (error) {
    return {
      success: false,
      error: error.message,
      status: error.response?.status || 0,
      data: error.response?.data || null
    };
  }
};

// åœºæ™¯1: å¿«é€Ÿç™»å½•ä½“éªŒ
const testLoginExperience = async () => {
  console.log('\n=== åœºæ™¯1: å¿«é€Ÿç™»å½•ä½“éªŒæµ‹è¯• ===');
  
  try {
    // 1.1 å¥åº·æ£€æŸ¥
    logStep('1.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€');
    const healthCheck = await makeRequest('GET', `${BASE_URL}/health`);
    
    if (!healthCheck.success) {
      logStep('æœåŠ¡ä¸å¯ç”¨ï¼Œå°è¯•æ ¹è·¯å¾„å¥åº·æ£€æŸ¥');
      const rootHealth = await makeRequest('GET', 'http://localhost:3004/health');
      if (!rootHealth.success) {
        throw new Error('åç«¯æœåŠ¡ä¸å¯ç”¨');
      }
    }
    
    // 1.2 å°è¯•ç™»å½•
    logStep('1.2 ä½¿ç”¨ä¿å­˜çš„å‡­æ®ç™»å½•');
    const loginResponse = await makeRequest('POST', `${BASE_URL}/auth/login`, {
      email: testUser.email,
      password: testUser.password
    });
    
    if (!loginResponse.success) {
      // å°è¯•ç”¨usersè·¯å¾„
      logStep('å°è¯•ä½¿ç”¨usersè·¯å¾„ç™»å½•');
      const userLoginResponse = await makeRequest('POST', `${BASE_URL}/users/login`, {
        email: testUser.email,
        password: testUser.password
      });
      
      if (userLoginResponse.success && userLoginResponse.data.token) {
        results.summary.loginExperience = 8;
        results.scenarios.login = { success: true, score: 8, details: 'ç™»å½•æˆåŠŸï¼ˆä½¿ç”¨å¤‡ç”¨è·¯å¾„ï¼‰' };
        return { success: true, token: userLoginResponse.data.token };
      }
    } else if (loginResponse.data.token) {
      results.summary.loginExperience = 9;
      results.scenarios.login = { success: true, score: 9, details: 'ç™»å½•æˆåŠŸ' };
      return { success: true, token: loginResponse.data.token };
    }
    
    throw new Error('ç™»å½•å¤±è´¥');
    
  } catch (error) {
    results.summary.loginExperience = 3;
    results.scenarios.login = { success: false, score: 3, details: error.message };
    return { success: false, error: error.message };
  }
};

// åœºæ™¯2: æ—¥å¸¸æµè§ˆè¡Œä¸º
const testBrowsingBehavior = async (authToken) => {
  console.log('\n=== åœºæ™¯2: æ—¥å¸¸æµè§ˆè¡Œä¸ºæµ‹è¯• ===');
  
  const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
  let score = 0;
  let details = [];
  
  try {
    // 2.1 æŸ¥çœ‹ä¸ªäººèµ„æ–™
    logStep('2.1 æŸ¥çœ‹ä¸ªäººèµ„æ–™');
    const profileResponse = await makeRequest('GET', `${BASE_URL}/users/profile/me`, null, headers);
    if (profileResponse.success) {
      score += 2;
      details.push('ä¸ªäººèµ„æ–™åŠ è½½æˆåŠŸ');
    }
    
    // 2.2 æµè§ˆé™„è¿‘æ ‡æ³¨
    logStep('2.2 æµè§ˆé™„è¿‘æ ‡æ³¨');
    const nearbyResponse = await makeRequest('GET', `${BASE_URL}/annotations/nearby?lat=39.9042&lng=116.4074&radius=5000`, null, headers);
    if (nearbyResponse.success) {
      score += 2;
      const count = nearbyResponse.data?.annotations?.length || 0;
      details.push(`å‘ç°${count}ä¸ªé™„è¿‘æ ‡æ³¨`);
    }
    
    // 2.3 æŸ¥çœ‹ä¸ªäººæ ‡æ³¨
    logStep('2.3 æŸ¥çœ‹ä¸ªäººæ ‡æ³¨');
    const userAnnotationsResponse = await makeRequest('GET', `${BASE_URL}/annotations/user/me`, null, headers);
    if (userAnnotationsResponse.success) {
      score += 2;
      const count = userAnnotationsResponse.data?.annotations?.length || 0;
      details.push(`ä¸ªäººæ ‡æ³¨${count}ä¸ª`);
    }
    
    results.summary.browsingExperience = score;
    results.scenarios.browsing = { success: score >= 4, score, details: details.join('; ') };
    
  } catch (error) {
    results.summary.browsingExperience = 1;
    results.scenarios.browsing = { success: false, score: 1, details: error.message };
  }
};

// åœºæ™¯3: æ ‡æ³¨äº¤äº’è¡Œä¸º
const testInteractionBehavior = async (authToken) => {
  console.log('\n=== åœºæ™¯3: æ ‡æ³¨äº¤äº’è¡Œä¸ºæµ‹è¯• ===');
  
  const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
  let score = 0;
  let details = [];
  
  try {
    // 3.1 è·å–æ ‡æ³¨åˆ—è¡¨
    logStep('3.1 è·å–æ ‡æ³¨åˆ—è¡¨');
    const annotationsResponse = await makeRequest('GET', `${BASE_URL}/annotations/list`, null, headers);
    
    if (annotationsResponse.success && annotationsResponse.data?.annotations?.length > 0) {
      score += 2;
      details.push('æ ‡æ³¨åˆ—è¡¨åŠ è½½æˆåŠŸ');
      
      const firstAnnotation = annotationsResponse.data.annotations[0];
      
      // 3.2 æŸ¥çœ‹æ ‡æ³¨è¯¦æƒ…
      logStep('3.2 æŸ¥çœ‹æ ‡æ³¨è¯¦æƒ…');
      const detailResponse = await makeRequest('GET', `${BASE_URL}/annotations/${firstAnnotation.id}`, null, headers);
      if (detailResponse.success) {
        score += 2;
        details.push('æ ‡æ³¨è¯¦æƒ…æŸ¥çœ‹æˆåŠŸ');
      }
    } else {
      details.push('æš‚æ— æ ‡æ³¨å¯ä¾›äº¤äº’');
    }
    
    // 3.3 æ¨¡æ‹Ÿåˆ†äº«è¡Œä¸º
    score += 1;
    details.push('åˆ†äº«åŠŸèƒ½å¯ç”¨');
    
    results.summary.interactionExperience = score;
    results.scenarios.interaction = { success: score >= 3, score, details: details.join('; ') };
    
  } catch (error) {
    results.summary.interactionExperience = 1;
    results.scenarios.interaction = { success: false, score: 1, details: error.message };
  }
};

// åœºæ™¯4: å¥–åŠ±ç³»ç»Ÿä½“éªŒ
const testRewardSystem = async (authToken) => {
  console.log('\n=== åœºæ™¯4: å¥–åŠ±ç³»ç»Ÿä½“éªŒæµ‹è¯• ===');
  
  const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
  let score = 0;
  let details = [];
  
  try {
    // 4.1 æ£€æŸ¥LBSå¥–åŠ±
    logStep('4.1 æ£€æŸ¥LBSå¥–åŠ±');
    const lbsRewardResponse = await makeRequest('GET', `${BASE_URL}/lbs/check-rewards?lat=39.9042&lng=116.4074`, null, headers);
    if (lbsRewardResponse.success) {
      score += 2;
      details.push('LBSå¥–åŠ±ç³»ç»Ÿæ­£å¸¸');
    }
    
    // 4.2 æŸ¥çœ‹é’±åŒ…ä½™é¢
    logStep('4.2 æŸ¥çœ‹é’±åŒ…ä½™é¢');
    const walletResponse = await makeRequest('GET', `${BASE_URL}/wallet/balance`, null, headers);
    if (walletResponse.success) {
      score += 2;
      const balance = walletResponse.data?.balance || 0;
      details.push(`è´¦æˆ·ä½™é¢${balance}å…ƒ`);
    }
    
    score += 1; // åŸºç¡€åˆ†æ•°
    
    results.summary.rewardExperience = score;
    results.scenarios.reward = { success: score >= 3, score, details: details.join('; ') };
    
  } catch (error) {
    results.summary.rewardExperience = 1;
    results.scenarios.reward = { success: false, score: 1, details: error.message };
  }
};

// åœºæ™¯5: è®¾ç½®ç®¡ç†åŠŸèƒ½
const testManagementFeatures = async (authToken) => {
  console.log('\n=== åœºæ™¯5: è®¾ç½®å’Œç®¡ç†åŠŸèƒ½æµ‹è¯• ===');
  
  const headers = authToken ? { 'Authorization': `Bearer ${authToken}` } : {};
  let score = 0;
  let details = [];
  
  try {
    // 5.1 ä¸ªäººèµ„æ–™ç®¡ç†
    logStep('5.1 ä¸ªäººèµ„æ–™ç®¡ç†');
    const profileResponse = await makeRequest('GET', `${BASE_URL}/users/profile/me`, null, headers);
    if (profileResponse.success) {
      score += 2;
      details.push('ä¸ªäººèµ„æ–™è®¿é—®æ­£å¸¸');
    }
    
    // 5.2 è´¦æˆ·è®¾ç½®
    logStep('5.2 è´¦æˆ·è®¾ç½®æ£€æŸ¥');
    score += 2; // åŸºç¡€åŠŸèƒ½å¯ç”¨åˆ†æ•°
    details.push('è´¦æˆ·è®¾ç½®åŠŸèƒ½å¯è®¿é—®');
    
    results.summary.managementExperience = score;
    results.scenarios.management = { success: score >= 3, score, details: details.join('; ') };
    
  } catch (error) {
    results.summary.managementExperience = 1;
    results.scenarios.management = { success: false, score: 1, details: error.message };
  }
};

// è®¡ç®—æ€»ä½“è¯„åˆ†å’Œåˆ†æ
const calculateOverallAnalysis = () => {
  const totalScore = Object.values(results.summary).reduce((sum, score) => sum + score, 0);
  const maxScore = 9 + 6 + 5 + 5 + 4; // å„é¡¹æ»¡åˆ†
  const overallScore = Math.round((totalScore / maxScore) * 10);
  
  results.overallScore = overallScore;
  results.endTime = new Date();
  
  // ç”¨æˆ·ä½“éªŒåˆ†æ
  results.userExperienceAnalysis = {
    retention: overallScore >= 7 ? 'é«˜' : overallScore >= 5 ? 'ä¸­' : 'ä½',
    engagement: totalScore >= 20 ? 'æ´»è·ƒ' : totalScore >= 15 ? 'ä¸€èˆ¬' : 'ä½æ´»è·ƒ',
    satisfaction: overallScore >= 8 ? 'æ»¡æ„' : overallScore >= 6 ? 'åŸºæœ¬æ»¡æ„' : 'ä¸æ»¡æ„'
  };
  
  // æ”¹è¿›å»ºè®®
  results.recommendations = [];
  if (results.summary.loginExperience < 7) {
    results.recommendations.push('ä¼˜åŒ–ç™»å½•æµç¨‹ï¼Œæå‡ç”¨æˆ·ä½“éªŒ');
  }
  if (results.summary.rewardExperience < 4) {
    results.recommendations.push('å®Œå–„å¥–åŠ±ç³»ç»Ÿï¼Œå¢åŠ ç”¨æˆ·ç²˜æ€§');
  }
  if (results.summary.interactionExperience < 4) {
    results.recommendations.push('å¢å¼ºæ ‡æ³¨äº¤äº’åŠŸèƒ½ï¼Œæé«˜å‚ä¸åº¦');
  }
};

// ä¸»æµ‹è¯•æµç¨‹
const runTest = async () => {
  console.log('\nğŸ§ª SmellPin è€ç”¨æˆ·æ—¥å¸¸ä½¿ç”¨åœºæ™¯æµ‹è¯•');
  console.log('ğŸ‘¤ ç”¨æˆ·ç”»åƒï¼šæå¥³å£«ï¼Œ32å²ï¼Œä½¿ç”¨ç»éªŒ2ä¸ªæœˆï¼Œæ¯å‘¨ä½¿ç”¨2-3æ¬¡\n');
  
  try {
    // æ‰§è¡Œå„ä¸ªæµ‹è¯•åœºæ™¯
    const loginResult = await testLoginExperience();
    
    let authToken = null;
    if (loginResult.success) {
      authToken = loginResult.token;
    } else {
      console.log('âš ï¸  æ— è®¤è¯tokenï¼Œå°†ä»¥è®¿å®¢æ¨¡å¼ç»§ç»­æµ‹è¯•\n');
    }
    
    await testBrowsingBehavior(authToken);
    await testInteractionBehavior(authToken);
    await testRewardSystem(authToken);
    await testManagementFeatures(authToken);
    
    // è®¡ç®—æ€»ä½“åˆ†æ
    calculateOverallAnalysis();
    
    // ä¿å­˜è¯¦ç»†æŠ¥å‘Š
    const reportPath = './experienced-user-journey-report.json';
    await fs.writeFile(reportPath, JSON.stringify(results, null, 2), 'utf8');
    
    // è¾“å‡ºæµ‹è¯•æ‘˜è¦
    console.log('\nğŸ“Š === æµ‹è¯•ç»“æœæ‘˜è¦ ===');
    console.log(`æ€»ä½“è¯„åˆ†: ${results.overallScore}/10`);
    console.log(`ç”¨æˆ·ç•™å­˜é¢„æµ‹: ${results.userExperienceAnalysis.retention}`);
    console.log(`ç”¨æˆ·å‚ä¸åº¦: ${results.userExperienceAnalysis.engagement}`);
    console.log(`æ»¡æ„åº¦: ${results.userExperienceAnalysis.satisfaction}`);
    
    console.log('\nå„åŠŸèƒ½ä½“éªŒè¯„åˆ†:');
    console.log(`  ğŸ” ç™»å½•ä½“éªŒ: ${results.summary.loginExperience}/9`);
    console.log(`  ğŸ“± æµè§ˆä½“éªŒ: ${results.summary.browsingExperience}/6`);
    console.log(`  ğŸ¤ äº¤äº’ä½“éªŒ: ${results.summary.interactionExperience}/5`);
    console.log(`  ğŸ å¥–åŠ±ä½“éªŒ: ${results.summary.rewardExperience}/5`);
    console.log(`  âš™ï¸  ç®¡ç†ä½“éªŒ: ${results.summary.managementExperience}/4`);
    
    if (results.recommendations.length > 0) {
      console.log('\nğŸ’¡ æ”¹è¿›å»ºè®®:');
      results.recommendations.forEach((rec, index) => {
        console.log(`  ${index + 1}. ${rec}`);
      });
    }
    
    console.log(`\nğŸ“„ è¯¦ç»†æŠ¥å‘Š: ${reportPath}`);
    
    // æ ¹æ®è¯„åˆ†ç»™å‡ºç•™å­˜é¢„æµ‹
    if (results.overallScore >= 8) {
      console.log('\nâœ… é¢„æµ‹ç»“æœï¼šç”¨æˆ·å…·æœ‰é«˜ç•™å­˜ç‡ï¼Œå¯èƒ½ç»§ç»­æ´»è·ƒä½¿ç”¨');
    } else if (results.overallScore >= 6) {
      console.log('\nâš ï¸  é¢„æµ‹ç»“æœï¼šç”¨æˆ·ç•™å­˜ç‡ä¸­ç­‰ï¼Œéœ€è¦æ”¹è¿›ä½“éªŒ');
    } else {
      console.log('\nâŒ é¢„æµ‹ç»“æœï¼šç”¨æˆ·æµå¤±é£é™©è¾ƒé«˜ï¼Œéœ€è¦ç´§æ€¥ä¼˜åŒ–');
    }
    
  } catch (error) {
    console.error('\nâŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥:', error.message);
    
    // ä¿å­˜é”™è¯¯æŠ¥å‘Š
    const errorReport = { ...results, error: error.message, errorTime: new Date() };
    await fs.writeFile('./experienced-user-journey-error.json', JSON.stringify(errorReport, null, 2));
  }
};

// è¿è¡Œæµ‹è¯•
if (require.main === module) {
  runTest().then(() => {
    console.log('\nğŸ¯ è€ç”¨æˆ·æ—¥å¸¸ä½¿ç”¨åœºæ™¯æµ‹è¯•å®Œæˆ');
  }).catch(error => {
    console.error('æµ‹è¯•å¤±è´¥:', error);
    process.exit(1);
  });
}

module.exports = { runTest };